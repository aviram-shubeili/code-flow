# Database Schema

This section defines the concrete Prisma schema for CodeFlow's MVP database. The schema implements Auth.js integration with minimal business domain tables, focusing only on user profiles and repository monitoring preferences.

### Prisma Schema Definition

**File:** `prisma/schema.prisma`

```prisma
// Prisma Schema for CodeFlow MVP
// Auth.js v5 integration with minimal business domain models

// ============================================================================
// Auth.js Required Tables (Auto-generated by @auth/prisma-adapter)
// ============================================================================
model Account {
  id                 String  @id @default(cuid())
  userId             String  @map("user_id")
  type               String
  provider           String
  providerAccountId  String  @map("provider_account_id")
  refresh_token      String? @db.Text
  access_token       String? @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String? @db.Text
  session_state      String?
 
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
 
  @@unique([provider, providerAccountId])
  @@map("accounts")
}
 
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
 
  @@map("sessions")
}
 
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  accounts      Account[]
  sessions      Session[]
 
  @@map("users")
}
 
model VerificationToken {
  identifier String
  token      String
  expires    DateTime
 
  @@unique([identifier, token])
  @@map("verification_tokens")
}
// ============================================================================
// CodeFlow Business Domain Tables
// ============================================================================

model UserProfile {
  id           String   @id @default(uuid())
  userId       String   @unique @map("user_id")
  githubId     Int      @unique @map("github_id")
  username     String   @unique
  lastActiveAt DateTime @default(now()) @map("last_active_at")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  
  // Relationships
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  repositories Repository[]
  
  @@map("user_profiles")
}

model Repository {
  id        String   @id @default(uuid())
  githubId  Int      @unique @map("github_id")
  name      String
  fullName  String   @unique @map("full_name")
  owner     String
  isActive  Boolean  @default(true) @map("is_active")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relationships
  userProfile UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Indexes for performance
  @@index([userId, isActive])
  @@index([fullName])
  @@map("repositories")
}
```

### Database Design Decisions

**Auth.js Integration:**
- **Standard Auth.js Tables**: `Account`, `Session`, `User`, `VerificationToken`
- **Snake_case Mapping**: Database columns use snake_case convention
- **Cascade Deletes**: User deletion removes all associated data
- **Unique Constraints**: Prevent duplicate GitHub integrations

**Business Domain Tables:**

#### UserProfile Table
- **Purpose**: Extends Auth.js User with GitHub-specific data
- **Key Fields**: `githubId`, `username`, `lastActiveAt` for cleanup
- **Relationships**: One-to-One with Auth.js User, One-to-Many with Repository
- **Indexes**: Auto-indexed on unique fields (`userId`, `githubId`, `username`)

#### Repository Table  
- **Purpose**: Stores user's repository monitoring preferences
- **Key Fields**: `githubId` (GitHub repo ID), `fullName` (owner/repo), `isActive`
- **Relationships**: Many-to-One with UserProfile (user can monitor multiple repos)
- **Indexes**: Composite index on `(userId, isActive)` for dashboard queries, `fullName` for lookups

### Database Migrations Strategy

**Migration Management:**
```bash
# Generate migration for schema changes
npx prisma migrate dev --name init

# Deploy to production
npx prisma migrate deploy

# Generate client after schema changes
npx prisma generate
```

**Initial Migration:** `001_init.sql`
```sql
-- Auth.js required tables
CREATE TABLE "accounts" (
  "id" TEXT NOT NULL,
  "user_id" TEXT NOT NULL,
  "type" TEXT NOT NULL,
  "provider" TEXT NOT NULL,
  "provider_account_id" TEXT NOT NULL,
  -- Additional Auth.js columns...
  
  CONSTRAINT "accounts_pkey" PRIMARY KEY ("id")
);

-- CodeFlow business tables
CREATE TABLE "user_profiles" (
  "id" TEXT NOT NULL,
  "user_id" TEXT NOT NULL,
  "github_id" INTEGER NOT NULL,
  "username" TEXT NOT NULL,
  "last_active_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "updated_at" TIMESTAMP(3) NOT NULL,
  
  CONSTRAINT "user_profiles_pkey" PRIMARY KEY ("id")
);

CREATE TABLE "repositories" (
  "id" TEXT NOT NULL,
  "github_id" INTEGER NOT NULL,
  "name" TEXT NOT NULL,
  "full_name" TEXT NOT NULL,
  "owner" TEXT NOT NULL,
  "is_active" BOOLEAN NOT NULL DEFAULT true,
  "user_id" TEXT NOT NULL,
  "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "updated_at" TIMESTAMP(3) NOT NULL,
  
  CONSTRAINT "repositories_pkey" PRIMARY KEY ("id")
);

-- Indexes and constraints
CREATE UNIQUE INDEX "user_profiles_user_id_key" ON "user_profiles"("user_id");
CREATE UNIQUE INDEX "user_profiles_github_id_key" ON "user_profiles"("github_id");
CREATE UNIQUE INDEX "repositories_github_id_key" ON "repositories"("github_id");
CREATE INDEX "repositories_user_id_is_active_idx" ON "repositories"("user_id", "is_active");
```

### Database Connection Configuration

**Environment Variables:**
```bash
# .env.local (development)
DATABASE_URL="postgresql://username:password@localhost:5432/codeflow_dev"

# .env.production (production - Neon)  
DATABASE_URL="postgresql://username:password@ep-xxx.neon.tech/codeflow?sslmode=require"
DIRECT_URL="postgresql://username:password@ep-xxx.neon.tech/codeflow?sslmode=require"

# Auth.js
NEXTAUTH_SECRET="your-secret-key"
NEXTAUTH_URL="http://localhost:3000"  # or production URL

# GitHub OAuth
GITHUB_CLIENT_ID="your-github-oauth-app-id"
GITHUB_CLIENT_SECRET="your-github-oauth-secret"
```

**Prisma Client Configuration:**
```typescript
// lib/prisma.ts
import { PrismaClient } from '@prisma/client'

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined
}

export const prisma = globalForPrisma.prisma ?? 
  new PrismaClient({
    log: ['query', 'error', 'warn'],
    datasources: {
      db: {
        url: process.env.DATABASE_URL,
      },
    },
  })

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma
```

### Performance Considerations

**Connection Pooling:**
- **Prisma Connection Pool**: Handles serverless connection management
- **Neon Pooler**: Built-in PgBouncer for serverless connections
- **Connection Limits**: Neon auto-scales based on usage

**Query Optimization:**
- **Selective Loading**: Only load required fields
- **Batch Operations**: Use Prisma transactions for bulk updates
- **Index Strategy**: Optimized for dashboard query patterns

**Example Optimized Queries:**
```typescript
// Efficient repository loading for dashboard
const repositories = await prisma.repository.findMany({
  where: { 
    userId: user.id, 
    isActive: true 
  },
  select: {
    id: true,
    githubId: true,
    fullName: true,
    owner: true,
  }
});

// Update last active timestamp efficiently  
await prisma.userProfile.update({
  where: { userId: session.user.id },
  data: { lastActiveAt: new Date() }
});
```

### Data Cleanup Strategy

**User Activity Tracking:**
- **lastActiveAt**: Updated on dashboard visits
- **Cleanup Job**: Remove inactive users after 90 days
- **Cascade Deletes**: Automatically remove associated repositories

**Repository Management:**
- **Soft Deletes**: Use `isActive: false` instead of hard deletes
- **Bulk Operations**: Efficient updates for multiple repositories

This database schema provides a minimal yet robust foundation for the MVP, with clear upgrade paths for future features.

