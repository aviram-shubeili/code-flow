# API Specification

This section defines the REST API endpoints for CodeFlow's MVP, implemented as Next.js API routes deployed on **Vercel**. All endpoints follow RESTful conventions and return consistent JSON responses with proper error handling.

**Base URL:** `https://codeflow.vercel.app` (production) | `http://localhost:3000` (development)  
**Authentication:** All endpoints require Auth.js session authentication except `/api/auth/*`  
**Content-Type:** `application/json` for all requests/responses  
**Rate Limiting:** Handled at application level with graceful degradation

### Authentication Endpoints

**Auth.js handles these automatically - no custom implementation needed:**

```typescript
// Auto-generated by Auth.js
POST /api/auth/signin/github     // Initiate GitHub OAuth
GET  /api/auth/callback/github   // OAuth callback handler  
POST /api/auth/signout          // Sign out user
GET  /api/auth/session          // Get current session
```

### User Profile Endpoints

**GET /api/profile**  
Get current user's profile information

```typescript
Response: {
  id: string;
  githubId: number;
  username: string;
  email: string;        // From Auth.js User table
  name: string | null;  // From Auth.js User table  
  image: string | null; // From Auth.js User table
  lastActiveAt: string; // ISO datetime
  createdAt: string;
  updatedAt: string;
}

Error Responses:
401 - User not authenticated
500 - Server error
```

**PATCH /api/profile**  
Update user's last active timestamp (called on dashboard interactions)

```typescript
Request: {
  lastActiveAt: string; // ISO datetime
}

Response: {
  success: boolean;
  lastActiveAt: string;
}

Error Responses:
401 - User not authenticated
400 - Invalid request body
500 - Server error
```

### Repository Management Endpoints

**GET /api/repositories**  
Get user's monitored repositories

```typescript
Response: {
  repositories: Repository[];
}

Query Parameters:
?active=true     // Filter by active status
?search=string   // Search by name/fullName

Error Responses:
401 - User not authenticated
500 - Server error
```

**POST /api/repositories**  
Add repository to monitoring

```typescript
Request: {
  githubId: number;
  name: string;
  fullName: string;
  owner: string;
}

Response: {
  repository: Repository;
}

Error Responses:
401 - User not authenticated
400 - Invalid repository data
403 - No access to repository
409 - Repository already exists
500 - Server error
```

**PATCH /api/repositories/{id}**  
Update repository monitoring settings

```typescript
Request: {
  isActive?: boolean;
}

Response: {
  repository: Repository;
}

Error Responses:
401 - User not authenticated
403 - Repository not owned by user
404 - Repository not found
500 - Server error
```

**DELETE /api/repositories/{id}**  
Remove repository from monitoring

```typescript
Response: {
  success: boolean;
}

Error Responses:
401 - User not authenticated
403 - Repository not owned by user  
404 - Repository not found
500 - Server error
```

### Pull Request Data Endpoints

**GET /api/pull-requests**  
Get dashboard data with four-section categorization (fetched live from GitHub API)

```typescript
Response: {
  needsReview: GitHubPullRequest[];    // PRs where user is requested reviewer
  returnedToYou: GitHubPullRequest[];  // User's PRs with changes requested
  myPRs: GitHubPullRequest[];          // All PRs authored by user  
  reviewedAwaiting: GitHubPullRequest[]; // PRs user reviewed, awaiting author
}

Query Parameters:
?repository=id   // Filter by specific repository
?state=open      // Filter by PR state (open|closed)
?limit=50        // Limit results per section (default: 100)

Error Responses:
401 - User not authenticated
429 - GitHub API rate limited for this user
500 - Server error
```

**GET /api/pull-requests/{owner}/{repo}/{number}**  
Get specific pull request details from GitHub API

```typescript
Response: {
  pullRequest: GitHubPullRequest & {
    reviews: GitHubReview[];
  };
}

Error Responses:
401 - User not authenticated
403 - No access to PR repository
404 - Pull request not found
429 - GitHub API rate limited for this user
500 - Server error
```

### GitHub Integration Endpoints

**GET /api/github/repositories**  
Fetch user's accessible repositories from GitHub API

```typescript
Response: {
  repositories: GitHubRepository[];
}

Query Parameters:
?search=string   // Search repositories
?type=all        // Type: all|owner|public|private (default: all)

Error Responses:
401 - User not authenticated
403 - GitHub token expired/invalid
429 - GitHub API rate limited for this user
500 - Server error
```

**GET /api/github/rate-limit**  
Get current GitHub API rate limit status for the authenticated user

```typescript
Response: {
  remaining: number;        // Requests remaining in current window
  used: number;            // Requests used in current window  
  limit: number;           // Total requests allowed per window (5000)
  resetAt: string;         // ISO datetime when limit resets
  isThrottled: boolean;    // Whether user is currently rate limited
}

Error Responses:
401 - User not authenticated
403 - GitHub token expired/invalid
500 - Server error
```

### System Health Endpoints

**GET /api/health**  
System health check (public endpoint)

```typescript
Response: {
  status: "ok" | "degraded" | "down";
  timestamp: string;
  services: {
    database: "ok" | "error";
    github: "ok" | "rate_limited" | "error";
  };
}

Error Responses:
500 - Service unhealthy
```

### Error Response Format

All API errors follow consistent format:

```typescript
interface ApiError {
  error: {
    code: string;           // Machine-readable error code
    message: string;        // Human-readable error message
    details?: any;          // Additional error context
    timestamp: string;      // ISO datetime
    requestId: string;      // Unique request identifier for debugging
  };
}

// Example error response
{
  "error": {
    "code": "REPOSITORY_ACCESS_DENIED", 
    "message": "You don't have access to this repository",
    "details": {
      "repositoryId": "123",
      "requiredPermission": "read"
    },
    "timestamp": "2025-08-24T14:30:00Z",
    "requestId": "req_abc123"
  }
}
```

### Common HTTP Status Codes

- **200 OK** - Request successful
- **201 Created** - Resource created successfully  
- **400 Bad Request** - Invalid request data
- **401 Unauthorized** - Authentication required
- **403 Forbidden** - Insufficient permissions
- **404 Not Found** - Resource not found
- **409 Conflict** - Resource already exists
- **429 Too Many Requests** - Rate limited
- **500 Internal Server Error** - Server error

### API Response Caching

**Client-Side Caching (TanStack Query) - Single Source of Truth:**
- **Dashboard data**: 2-minute stale time, 5-minute cache time (live GitHub API calls)
- **Repository list**: 10-minute stale time, 20-minute cache time (GitHub API calls)  
- **PR details**: 1-minute stale time, 3-minute cache time (live GitHub API calls)
- **GitHub rate limits**: 30-second stale time, 1-minute cache time (user-specific)
- **User repositories**: 15-minute stale time, 30-minute cache time (GitHub API calls)

**No Server-Side Caching for MVP:**
- All data fetched directly from GitHub API on each request
- Database stores only user profiles and repository monitoring preferences
- TanStack Query handles all performance optimization through intelligent client-side caching
- Each user's rate limit is independent (5000 requests/hour per GitHub token)

