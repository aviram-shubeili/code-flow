# <!-- Powered by BMAD™ Core -->

# Story 0.3: Quality Gates & Database Migration Setup

## Status
Draft

## Story
**As a** developer,
**I want** quality gates and database migration automation established so that code quality is enforced and database changes are safely deployed while the chosen platform handles deployment automatically,
**so that** I can ensure reliable deployments and maintain code quality standards.

## Acceptance Criteria
1. GitHub Actions workflow for quality gates (test, lint, build validation)
2. Database migration automation for production deployments
3. Branch protection rules that work with Amplify's automatic deployment
4. Build quality gates that prevent bad code from reaching Amplify deployment
5. Database migration status reporting and rollback procedures
6. Integration with Amplify Gen 2's Git-based deployment workflow

## Tasks / Subtasks

- [ ] Task 1: Create GitHub Actions Quality Gates Workflow (AC: 1, 4)
  - [ ] Create `.github/workflows/quality-gates.yml` workflow file
  - [ ] Configure Node.js 18+ environment with npm caching
  - [ ] Add type checking step using `npm run type-check`
  - [ ] Add linting step using `npm run lint`
  - [ ] Add test execution step using `npm run test`
  - [ ] Add build validation step using `npm run build` with dummy environment variables
  - [ ] Configure workflow to run on push to main/staging branches and all pull requests
  - [ ] Set up job dependencies to fail fast on first quality gate failure

- [ ] Task 2: Implement Database Migration Automation (AC: 2, 5)
  - [ ] Create database migration job in quality-gates workflow
  - [ ] Configure Prisma migrate deploy command for production
  - [ ] Set up database connection using AWS Secrets Manager for production DATABASE_URL
  - [ ] Implement migration status reporting with proper error handling
  - [ ] Create rollback procedure documentation
  - [ ] Configure migration job to run only on main branch (production) after quality gates pass
  - [ ] Add migration verification step to ensure schema matches expected state

- [ ] Task 3: Configure Branch Protection Rules (AC: 3, 4)
  - [ ] Set up GitHub branch protection for main branch
  - [ ] Require quality-gates workflow to pass before merge
  - [ ] Require pull request reviews before merging to main
  - [ ] Restrict force pushes to protected branches
  - [ ] Configure status checks integration with Amplify deployment
  - [ ] Document branch protection strategy for team

- [ ] Task 4: Set Up E2E Testing for Pull Requests (AC: 1, 4)
  - [ ] Add conditional E2E testing step for pull requests only
  - [ ] Configure test database environment for E2E tests
  - [ ] Set up dummy environment variables for E2E test execution
  - [ ] Implement E2E test execution using `npm run test:e2e`
  - [ ] Configure E2E tests to run in headless mode for CI

- [ ] Task 5: Integrate with Amplify Gen 2 Deployment Workflow (AC: 6)
  - [ ] Configure Amplify to respect GitHub status checks
  - [ ] Document integration between quality gates and Amplify deployment
  - [ ] Set up automatic deployment triggers after successful quality gates
  - [ ] Configure environment-specific deployment based on branch (main=production, staging=staging)
  - [ ] Verify deployment rollback capabilities with Amplify Console

- [ ] Task 6: Create Migration Status Monitoring and Documentation (AC: 5)
  - [ ] Create `scripts/migrate.sh` script for manual migration execution
  - [ ] Implement migration status checking functionality
  - [ ] Document rollback procedures in deployment documentation
  - [ ] Set up CloudWatch logging for migration status tracking
  - [ ] Create troubleshooting guide for common migration issues

## Dev Notes

### Previous Story Insights
From story 0.2, we have a comprehensive testing framework with Vitest, React Testing Library, and proper mock configurations. All tests are passing with coverage reporting configured at 80% thresholds. The testing infrastructure provides a solid foundation for quality gates.

### Technology Stack Requirements
[Source: architecture/tech-stack.md]

**Required CI/CD Technologies:**
- **CI/CD Platform**: GitHub Actions (native GitHub integration, AWS deployment actions)
- **Build Tool**: Next.js + Turbo 14.0+ / 1.10+ (monorepo build system, optimized for serverless deployment)
- **Testing Framework**: Vitest 1.6+ + Testing Library 14+ (already configured in 0.2)
- **E2E Testing**: Playwright 1.40+ (cross-browser reliability, excellent CI/CD integration)
- **Infrastructure Tool**: AWS CDK 2.100+ (TypeScript-native, excellent Lambda/RDS deployment)

### Deployment Strategy Integration
[Source: architecture/deployment-strategy.md]

**Amplify Gen 2 Deployment Pipeline:**
- **Git-based Deployment**: Amplify automatically deploys on successful quality gates
- **Environment Management**: Main branch → Production, Staging branch → Staging deployment
- **Quality Gates Integration**: GitHub Actions workflow must pass before Amplify deployment triggers
- **Database Migration Strategy**: Run migrations in GitHub Actions before Amplify deployment starts

**Required GitHub Actions Configuration:**
```yaml
# .github/workflows/quality-gates.yml structure
name: Quality Gates for Amplify Deployment
on:
  push: [main, staging]
  pull_request: [main]
env:
  NODE_VERSION: 18
jobs:
  quality-gates:
    # Type checking, linting, testing, build validation
  migrate-database:
    # Database migrations (production only)
    if: github.ref == 'refs/heads/main'
    needs: quality-gates
```

### Database Migration Requirements
[Source: architecture/database-schema.md]

**Prisma Migration Strategy:**
- **Development**: Use `prisma migrate dev` for local schema changes
- **Production**: Use `prisma migrate deploy` for production deployments
- **Migration Commands**: `npx prisma migrate deploy` (no interactive prompts)
- **Connection**: Production DATABASE_URL from AWS Secrets Manager
- **Rollback**: Document manual rollback procedures using Prisma schema history

**Database Schema Validation:**
```typescript
// Migration verification steps
npx prisma generate
npx prisma migrate deploy
npx prisma validate
```

### Development Workflow Integration
[Source: architecture/development-workflow.md]

**Quality Gates Requirements:**
- **Type Checking**: `npm run type-check --noEmit` (must pass TypeScript strict mode)
- **Linting**: `npm run lint` (ESLint with TypeScript rules)
- **Unit Testing**: `npm run test` (Vitest with 80% coverage enforcement)
- **E2E Testing**: `npm run test:e2e` (Playwright for pull requests)
- **Build Validation**: `npm run build` (Next.js production build with dummy env vars)

**Branch Protection Strategy:**
- **Protected Branches**: main, staging
- **Required Checks**: quality-gates workflow status
- **Review Requirements**: Pull request reviews required
- **Merge Strategy**: Squash and merge preferred

### Project Structure Alignment
[Source: architecture/unified-project-structure.md]

**Required Directory Structure:**
```
codeflow/
├── .github/workflows/
│   └── quality-gates.yml           # Main quality gates workflow
├── scripts/
│   ├── migrate.sh                  # Manual migration script
│   └── cleanup-users.ts            # User cleanup automation
├── docs/deployment/
│   ├── github-actions.md           # GitHub Actions setup guide
│   └── database-migrations.md      # Migration procedures
```

**Environment Variables Validation:**
[Source: architecture/coding-standards.md]
- All environment variables must be validated using Zod schemas in `lib/env.ts`
- CI/CD must use dummy values for build validation
- Production secrets managed through GitHub repository secrets

### Testing Standards Integration
[Source: architecture/coding-standards.md]

**CI/CD Testing Requirements:**
- **Test File Coverage**: Unit tests must achieve 80% coverage thresholds
- **Type Safety**: All tests must pass TypeScript strict mode compilation
- **Mock Configuration**: Use established mocks from tests/__mocks__/ directory
- **E2E Test Execution**: Headless Playwright execution in CI environment
- **Database Testing**: Use test database for E2E tests with proper cleanup

**Quality Gate Failure Handling:**
```bash
# Fast failure strategy
set -e  # Exit on first error
npm run type-check
npm run lint
npm run test
npm run build
```

### File Locations and Naming Conventions
[Source: architecture/unified-project-structure.md]

**GitHub Actions Files:**
- Workflow file: `.github/workflows/quality-gates.yml`
- Deployment documentation: `docs/deployment/github-actions.md`
- Migration scripts: `scripts/migrate.sh`

**Environment Configuration:**
- CI secrets: Configure in GitHub repository settings
- Dummy build variables: Hardcoded in workflow file for build validation
- Production DATABASE_URL: AWS Secrets Manager integration

### AWS Integration Requirements
[Source: architecture/deployment-strategy.md]

**Amplify Gen 2 Integration:**
- **Status Checks**: Amplify waits for GitHub status checks before deployment
- **Automatic Deployment**: Successful quality gates trigger Amplify deployment
- **Environment Variables**: Production secrets injected by Amplify during deployment
- **Rollback Strategy**: Amplify Console provides deployment rollback capabilities

**Database Migration Timing:**
1. Quality gates pass successfully
2. Database migrations run via GitHub Actions
3. Amplify deployment begins (infrastructure handles application deployment)
4. Application connects to migrated database

## Testing

### Test File Locations
[Source: architecture/unified-project-structure.md]
- GitHub Actions workflow: `.github/workflows/quality-gates.yml`
- Migration script: `scripts/migrate.sh`
- Branch protection configuration: GitHub repository settings
- Documentation: `docs/deployment/github-actions.md`, `docs/deployment/database-migrations.md`

### Testing Standards
**CI/CD Workflow Validation:**
1. Quality gates workflow executes successfully on pull requests
2. Database migration automation works in production environment
3. Branch protection prevents direct pushes to main branch
4. E2E tests run successfully in CI environment
5. Build validation passes with dummy environment variables
6. Amplify deployment integration works correctly

**Manual Testing Requirements:**
- Test pull request workflow with failing and passing quality gates
- Verify branch protection enforcement
- Test database migration rollback procedures
- Validate Amplify deployment integration

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-21 | 1.0 | Initial story creation for quality gates and database migration automation | Scrum Master (Bob) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by the development agent*

### Debug Log References  
*To be filled by the development agent*

### Completion Notes List
*To be filled by the development agent*

### File List
*To be filled by the development agent*

## QA Results
*This section will be populated by the QA agent during review*