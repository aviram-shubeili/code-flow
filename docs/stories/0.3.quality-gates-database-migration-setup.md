# Story 0.3: Quality Gates & Database Migration Setup

Status: in-progress

> **ðŸ“‹ Scope Reduction Note:** This story was split for MVP delivery. Basic quality gates (CI workflow + branch protection docs) were implemented in Sprint 0. Remaining tasks (DB migration automation, E2E testing, Vercel integration) deferred to post-MVP. See `_bmad-output/implementation-artifacts/0-3-quality-gates-database-migration-setup.md` for MVP implementation details.

## Story
**As a** developer,
**I want** quality gates and database migration automation established so that code quality is enforced and database changes are safely deployed while Vercel handles deployment automatically,
**so that** I can ensure reliable deployments and maintain code quality standards.

## Acceptance Criteria
1. GitHub Actions workflow for quality gates (test, lint, build validation)
2. Database migration automation for production deployments
3. Branch protection rules that work with Vercel's automatic deployment
4. Build quality gates that prevent bad code from reaching Vercel deployment
5. Database migration status reporting and rollback procedures
6. Integration with Vercel's Git-based deployment workflow

## Tasks / Subtasks

- [x] Task 1: Create GitHub Actions Quality Gates Workflow (AC: 1, 4) âœ… *MVP Complete*
  - [x] Create `.github/workflows/ci.yml` workflow file *(renamed from quality-gates.yml)*
  - [x] Configure Node.js 20 environment with npm caching
  - [x] Add type checking step using `npx tsc --noEmit`
  - [x] Add linting step using `npm run lint`
  - [x] Add test execution step using `npm run test`
  - [x] Add build validation step using `npm run build` with dummy environment variables
  - [x] Configure workflow to run on push to main and all pull requests
  - [x] Set up job dependencies to fail fast on first quality gate failure

- [ ] Task 2: Implement Database Migration Automation (AC: 2, 5) *Deferred to post-MVP*
  - [ ] Create database migration job in quality-gates workflow
  - [ ] Configure Prisma migrate deploy command for production
  - [ ] Set up database connection using GitHub Secrets for production DATABASE_URL (from Neon)
  - [ ] Implement migration status reporting with proper error handling
  - [ ] Create rollback procedure documentation
  - [ ] Configure migration job to run only on main branch (production) after quality gates pass
  - [ ] Add migration verification step to ensure schema matches expected state

- [x] Task 3: Configure Branch Protection Rules (AC: 3, 4) âœ… *MVP Complete (docs only)*
  - [x] Set up GitHub branch protection for main branch *(documented in README)*
  - [x] Require quality-gates workflow to pass before merge *(documented)*
  - [x] Require pull request reviews before merging to main *(documented)*
  - [x] Restrict force pushes to protected branches *(documented)*
  - [ ] Configure status checks integration with Vercel deployment *Deferred*
  - [x] Document branch protection strategy for team

- [ ] Task 4: Set Up E2E Testing for Pull Requests (AC: 1, 4) *Deferred to post-MVP*
  - [ ] Add conditional E2E testing step for pull requests only
  - [ ] Configure test database environment for E2E tests
  - [ ] Set up dummy environment variables for E2E test execution
  - [ ] Implement E2E test execution using `npm run test:e2e`
  - [ ] Configure E2E tests to run in headless mode for CI

- [ ] Task 5: Integrate with Vercel Deployment Workflow (AC: 6)
  - [ ] Connect Vercel project to GitHub repository
  - [ ] Document integration between quality gates and Vercel deployment
  - [ ] Verify automatic deployment triggers after successful quality gates
  - [ ] Configure environment-specific deployment based on branch (main=production, PRs=preview)
  - [ ] Verify deployment rollback capabilities with Vercel Dashboard

- [ ] Task 6: Create Migration Status Monitoring and Documentation (AC: 5)
  - [ ] Create `scripts/migrate.sh` script for manual migration execution
  - [ ] Implement migration status checking functionality
  - [ ] Document rollback procedures in deployment documentation
  - [ ] Set up Vercel logging for migration status tracking
  - [ ] Create troubleshooting guide for common migration issues

## Dev Notes

### Previous Story Insights
From story 0.2, we have a comprehensive testing framework with Vitest, React Testing Library, and proper mock configurations. All tests are passing with coverage reporting configured at 80% thresholds. The testing infrastructure provides a solid foundation for quality gates.

### Technology Stack Requirements
[Source: architecture/tech-stack.md]

**Required CI/CD Technologies:**
- **CI/CD Platform**: GitHub Actions (native GitHub integration, Vercel deployment via GitHub)
- **Build Tool**: Next.js + Turbopack 15.0+ (monorepo build system, optimized for Vercel deployment)
- **Testing Framework**: Vitest 1.6+ + Testing Library 14+ (already configured in 0.2)
- **E2E Testing**: Playwright 1.40+ (cross-browser reliability, excellent CI/CD integration)
- **Hosting**: Vercel (automatic deployment via GitHub integration)

### Deployment Strategy Integration
[Source: architecture/deployment-strategy.md]

**Vercel Deployment Pipeline:**
- **Git-based Deployment**: Vercel automatically deploys on successful push to main
- **Environment Management**: Main branch â†’ Production, PR branches â†’ Preview deployments
- **Quality Gates Integration**: GitHub Actions workflow must pass before merge to main
- **Database Migration Strategy**: Run migrations in GitHub Actions before/after Vercel deployment

**Required GitHub Actions Configuration:**
```yaml
# .github/workflows/quality-gates.yml structure
name: Quality Gates for Vercel Deployment
on:
  push: [main]
  pull_request: [main]
env:
  NODE_VERSION: 22
jobs:
  quality-gates:
    # Type checking, linting, testing, build validation
  migrate-database:
    # Database migrations (production only)
    if: github.ref == 'refs/heads/main'
    needs: quality-gates
```

### Database Migration Requirements
[Source: architecture/database-schema.md]

**Prisma Migration Strategy:**
- **Development**: Use `prisma migrate dev` for local schema changes
- **Production**: Use `prisma migrate deploy` for production deployments
- **Migration Commands**: `npx prisma migrate deploy` (no interactive prompts)
- **Connection**: Production DATABASE_URL from GitHub Secrets (Neon connection string)
- **Rollback**: Document manual rollback procedures using Prisma schema history + Neon branching

**Database Schema Validation:**
```typescript
// Migration verification steps
npx prisma generate
npx prisma migrate deploy
npx prisma validate
```

### Development Workflow Integration
[Source: architecture/development-workflow.md]

**Quality Gates Requirements:**
- **Type Checking**: `npm run type-check --noEmit` (must pass TypeScript strict mode)
- **Linting**: `npm run lint` (ESLint with TypeScript rules)
- **Unit Testing**: `npm run test` (Vitest with 80% coverage enforcement)
- **E2E Testing**: `npm run test:e2e` (Playwright for pull requests)
- **Build Validation**: `npm run build` (Next.js production build with dummy env vars)

**Branch Protection Strategy:**
- **Protected Branches**: main, staging
- **Required Checks**: quality-gates workflow status
- **Review Requirements**: Pull request reviews required
- **Merge Strategy**: Squash and merge preferred

### Project Structure Alignment
[Source: architecture/unified-project-structure.md]

**Required Directory Structure:**
```
codeflow/
â”œâ”€â”€ .github/workflows/
â”‚   â””â”€â”€ quality-gates.yml           # Main quality gates workflow
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ migrate.sh                  # Manual migration script
â”‚   â””â”€â”€ cleanup-users.ts            # User cleanup automation
â”œâ”€â”€ docs/deployment/
â”‚   â”œâ”€â”€ github-actions.md           # GitHub Actions setup guide
â”‚   â””â”€â”€ database-migrations.md      # Migration procedures
```

**Environment Variables Validation:**
[Source: architecture/coding-standards.md]
- All environment variables must be validated using Zod schemas in `lib/env.ts`
- CI/CD must use dummy values for build validation
- Production secrets managed through GitHub repository secrets

### Testing Standards Integration
[Source: architecture/coding-standards.md]

**CI/CD Testing Requirements:**
- **Test File Coverage**: Unit tests must achieve 80% coverage thresholds
- **Type Safety**: All tests must pass TypeScript strict mode compilation
- **Mock Configuration**: Use established mocks from tests/__mocks__/ directory
- **E2E Test Execution**: Headless Playwright execution in CI environment
- **Database Testing**: Use test database for E2E tests with proper cleanup

**Quality Gate Failure Handling:**
```bash
# Fast failure strategy
set -e  # Exit on first error
npm run type-check
npm run lint
npm run test
npm run build
```

### File Locations and Naming Conventions
[Source: architecture/unified-project-structure.md]

**GitHub Actions Files:**
- Workflow file: `.github/workflows/quality-gates.yml`
- Deployment documentation: `docs/deployment/github-actions.md`
- Migration scripts: `scripts/migrate.sh`

**Environment Configuration:**
- CI secrets: Configure in GitHub repository settings
- Dummy build variables: Hardcoded in workflow file for build validation
- Production DATABASE_URL: GitHub Secrets (from Neon)

### Vercel Integration Requirements
[Source: architecture/deployment-strategy.md]

**Vercel Integration:**
- **Automatic Deployment**: Vercel automatically deploys on push to main
- **Preview Deployments**: Vercel creates preview URLs for all PRs
- **Environment Variables**: Production secrets configured in Vercel Dashboard
- **Rollback Strategy**: Vercel Dashboard provides instant deployment rollback

**Database Migration Timing:**
1. Quality gates pass successfully in GitHub Actions
2. Code merges to main branch
3. Database migrations run via GitHub Actions (post-merge)
4. Vercel deployment triggers automatically
5. Application connects to migrated Neon database

## Testing

### Test File Locations
[Source: architecture/unified-project-structure.md]
- GitHub Actions workflow: `.github/workflows/quality-gates.yml`
- Migration script: `scripts/migrate.sh`
- Branch protection configuration: GitHub repository settings
- Documentation: `docs/deployment/github-actions.md`, `docs/deployment/database-migrations.md`

### Testing Standards
**CI/CD Workflow Validation:**
1. Quality gates workflow executes successfully on pull requests
2. Database migration automation works in production environment
3. Branch protection prevents direct pushes to main branch
4. E2E tests run successfully in CI environment
5. Build validation passes with dummy environment variables
6. Vercel deployment integration works correctly

**Manual Testing Requirements:**
- Test pull request workflow with failing and passing quality gates
- Verify branch protection enforcement
- Test database migration rollback procedures
- Validate Vercel deployment integration

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-21 | 1.0 | Initial story creation for quality gates and database migration automation | Scrum Master (Bob) |

## Dev Agent Record

### Context Reference

<!-- Path(s) to story context XML will be added here by context workflow -->

### Agent Model Used
*To be filled by the development agent*

### Debug Log References  
*To be filled by the development agent*

### Completion Notes List
*To be filled by the development agent*

### File List
*To be filled by the development agent*

## QA Results
*This section will be populated by the QA agent during review*